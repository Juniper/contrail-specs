1. Introduction

Tor service Node 
Runs below services :
contrail-tor-agent (ovsdb client) 
contrail-vrouter-agent with agent_mode=tsn in contrail-vrouter-agent.conf
vrouter.ko is present on the node.

contrail-vrouter-agent config objects and connections:
virtual-router-object with type tor-service-node
xmpp connection to control node.

contrail-tor-agent connections and config objects:

config obect:
virtual-router object with type tor-agent
physical router config object with references to tor agent and vrouter agent defined above.
xmpp connection to control node 
tcp/pssl connection to TOR switch .

HA Solution:

Two tor-agent with same ovs port and tor switch name are redundant .

Ha proxy runs on a node in cluster with TOR switch having configured to 
use this node as tcp/pssl session endpoint.

haproxy.cfg is generated by parsing tor agent configuration and redundant tor
agent port and ip is written to this config file .

haproxy binds on *:ovs_port and proxies connections to backend servers .

If one tor-agent process listening on a specific ovs port goes down , 
session is proxied to another tor-agent listening on same ovs port for one TOR switch.

Scale requirements for vrouter module on tsn node:
set using below config parameters in vrouter.conf:
VR_MPLS_LABELS VR_NEXTHOPS VR_VRFS VR_BRIDGE_ENTRIES VR_FLOW_ENTRIES

2. Problem statement
Add container for contrail-tor-agent.
Support add and delete of tor agent container.
Make vrouter module parameters configurable.

3. Proposed solution

Run contrail-tor-agent in container.
For each Tor switch add one tor agent container . For high availability one
tor agent container is deployed on each tsn node (total 2 tsn nodes) for
each tor switch. Multiple contrail-tor-agent containers need to run on a
tsn node with different config provided by env files. Tor agent container
should depend on contrail-vrouter-agent container, hence extend docker compose
service template for contrail-vrouter-agent.

Add Ha proxy container, add as part of external container, use entrypoint.sh and
ansible deployer to generate redundant config .

update vrouter.conf for scale parameters.

Follow compute add/delete flow to support tor-agent add/delete .

3. Use cases
Supports extending a cluster to include bare metal servers
and other virtual instances connected to a top-of-rack (ToR)
switch that supports the Open vSwitch Database Management (OVSDB) protocol. 

4. Provision Architecture and Workflow Changes
Add tsn_haproxy role for haproxy container.
Add tor_agent_config in ansible inventory file.

5.  Implementation
Add tor agent container and haproxy container.
Add tasks to read config and deploy tor agent containers 
and haproxy container.

5. Performance and scaling impact
test with scale config

6. Upgrade
TBD

7. Deprecations
N/A

8. Dependencies
N/A

9. Testing
Launch multiple tor-agent containers, launch vn and add 
bms to virtual network incontrail cluster ping to multicast 
address from bms should be responded by vms on all computes.
Do Ha test .

10. Documentation Impact
Add inventory file in ansible deployer.

11. Scope
R5.1

12. References
https://github.com/Juniper/contrail-controller/wiki/Baremetal-Support
